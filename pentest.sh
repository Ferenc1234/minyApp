#!/bin/bash
# Penetration Testing Script for Mine Gambling Game

set -e

BASE_URL="${1:-http://localhost:8000}"
VERBOSE="${2:-false}"

echo "========================================"
echo "Mine Gambling Game - Penetration Tests"
echo "========================================"
echo "Base URL: $BASE_URL"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Test counters
PASSED=0
FAILED=0
TOTAL=0

# Helper function for tests
test_endpoint() {
    TOTAL=$((TOTAL + 1))
    local name="$1"
    local method="$2"
    local endpoint="$3"
    local data="$4"
    local expected_code="$5"
    local headers="$6"
    
    echo -n "Testing: $name ... "
    
    if [ "$method" = "GET" ]; then
        response=$(curl -s -w "\n%{http_code}" -X GET "$BASE_URL$endpoint" $headers 2>/dev/null || echo "000")
    else
        response=$(curl -s -w "\n%{http_code}" -X $method "$BASE_URL$endpoint" \
            -H "Content-Type: application/json" \
            $headers \
            -d "$data" 2>/dev/null || echo "000")
    fi
    
    http_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | head -n-1)
    
    if [ "$VERBOSE" = "true" ]; then
        echo ""
        echo "Response code: $http_code"
        echo "Response body: $body"
        echo ""
    fi
    
    if [ "$http_code" = "$expected_code" ]; then
        echo -e "${GREEN}✓ PASS${NC} (HTTP $http_code)"
        PASSED=$((PASSED + 1))
        return 0
    else
        echo -e "${RED}✗ FAIL${NC} (Expected $expected_code, got $http_code)"
        FAILED=$((FAILED + 1))
        [ "$VERBOSE" = "true" ] && echo "Body: $body"
        return 1
    fi
}

# Wait for application to be ready
echo "Waiting for application to be ready..."
MAX_RETRIES=30
RETRY=0
while [ $RETRY -lt $MAX_RETRIES ]; do
    if curl -s "$BASE_URL/health" > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Application is ready${NC}"
        break
    fi
    RETRY=$((RETRY + 1))
    sleep 1
done

if [ $RETRY -eq $MAX_RETRIES ]; then
    echo -e "${RED}✗ Application did not become ready in time${NC}"
    exit 1
fi

echo ""
echo "========================================="
echo "1. BASIC HEALTH CHECKS"
echo "========================================="

test_endpoint "Health Check" "GET" "/health" "" "200" ""
test_endpoint "API Status" "GET" "/api/status" "" "200" ""
test_endpoint "Root Endpoint" "GET" "/" "" "200" ""

echo ""
echo "========================================="
echo "2. AUTHENTICATION SECURITY"
echo "========================================="

# Test registration
RANDOM_USER="testuser_$$_$RANDOM"
RANDOM_PASS="SecurePass123!"

test_endpoint "Register New User" "POST" "/api/auth/register" \
    "{\"username\":\"$RANDOM_USER\",\"password\":\"$RANDOM_PASS\"}" \
    "200" ""

# Try to register same user again (should fail)
test_endpoint "Register Duplicate User (should fail)" "POST" "/api/auth/register" \
    "{\"username\":\"$RANDOM_USER\",\"password\":\"$RANDOM_PASS\"}" \
    "400" ""

# Test weak password
test_endpoint "Register With Weak Password (should fail)" "POST" "/api/auth/register" \
    "{\"username\":\"weak_$RANDOM\",\"password\":\"123\"}" \
    "422" ""

# Test login
LOGIN_RESPONSE=$(curl -s -X POST "$BASE_URL/api/auth/login" \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"$RANDOM_USER\",\"password\":\"$RANDOM_PASS\"}")

TOKEN=$(echo "$LOGIN_RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

if [ -n "$TOKEN" ]; then
    echo -e "${GREEN}✓ Login successful, token obtained${NC}"
    PASSED=$((PASSED + 1))
else
    echo -e "${RED}✗ Login failed, no token${NC}"
    FAILED=$((FAILED + 1))
fi
TOTAL=$((TOTAL + 1))

# Test login with wrong password
test_endpoint "Login With Wrong Password (should fail)" "POST" "/api/auth/login" \
    "{\"username\":\"$RANDOM_USER\",\"password\":\"WrongPassword123\"}" \
    "401" ""

# Test SQL injection in login
test_endpoint "SQL Injection in Login (should fail)" "POST" "/api/auth/login" \
    "{\"username\":\"admin' OR '1'='1\",\"password\":\"anything\"}" \
    "401" ""

echo ""
echo "========================================="
echo "3. AUTHORIZATION CHECKS"
echo "========================================="

# Test protected endpoint without token
test_endpoint "Access Profile Without Token (should fail)" "GET" "/api/user/profile" "" "403" ""

# Test with invalid token
test_endpoint "Access Profile With Invalid Token (should fail)" "GET" "/api/user/profile" "" "401" \
    '-H "Authorization: Bearer invalid_token_here"'

# Test with valid token
if [ -n "$TOKEN" ]; then
    test_endpoint "Access Profile With Valid Token" "GET" "/api/user/profile" "" "200" \
        "-H \"Authorization: Bearer $TOKEN\""
fi

echo ""
echo "========================================="
echo "4. GAME LOGIC SECURITY"
echo "========================================="

if [ -n "$TOKEN" ]; then
    # Test creating game with valid parameters
    test_endpoint "Create Game With Valid Parameters" "POST" "/api/games/new" \
        "{\"bet_amount\":100,\"grid_size\":3,\"mines_count\":2}" \
        "200" \
        "-H \"Authorization: Bearer $TOKEN\""
    
    # Test creating game with invalid grid size
    test_endpoint "Create Game With Invalid Grid (should fail)" "POST" "/api/games/new" \
        "{\"bet_amount\":100,\"grid_size\":10,\"mines_count\":2}" \
        "422" \
        "-H \"Authorization: Bearer $TOKEN\""
    
    # Test creating game with too many mines
    test_endpoint "Create Game With Too Many Mines (should fail)" "POST" "/api/games/new" \
        "{\"bet_amount\":100,\"grid_size\":3,\"mines_count\":10}" \
        "400" \
        "-H \"Authorization: Bearer $TOKEN\""
    
    # Test creating game with negative bet
    test_endpoint "Create Game With Negative Bet (should fail)" "POST" "/api/games/new" \
        "{\"bet_amount\":-100,\"grid_size\":3,\"mines_count\":2}" \
        "422" \
        "-H \"Authorization: Bearer $TOKEN\""
    
    # Test creating game with excessive bet
    test_endpoint "Create Game With Excessive Bet (should fail)" "POST" "/api/games/new" \
        "{\"bet_amount\":999999999,\"grid_size\":3,\"mines_count\":2}" \
        "400" \
        "-H \"Authorization: Bearer $TOKEN\""
fi

echo ""
echo "========================================="
echo "5. INPUT VALIDATION"
echo "========================================="

# Test XSS in registration
test_endpoint "XSS in Username (should be sanitized)" "POST" "/api/auth/register" \
    "{\"username\":\"<script>alert('xss')</script>\",\"password\":\"Test123456\"}" \
    "200" ""

# Test very long input
test_endpoint "Very Long Username (should fail)" "POST" "/api/auth/register" \
    "{\"username\":\"$(python3 -c 'print("a"*1000)')\",\"password\":\"Test123456\"}" \
    "422" ""

echo ""
echo "========================================="
echo "6. LEADERBOARD & STATS"
echo "========================================="

if [ -n "$TOKEN" ]; then
    test_endpoint "Get User Stats" "GET" "/api/user/stats" "" "200" \
        "-H \"Authorization: Bearer $TOKEN\""
    
    test_endpoint "Get Leaderboard" "GET" "/api/user/leaderboard" "" "200" \
        "-H \"Authorization: Bearer $TOKEN\""
    
    test_endpoint "Get Game History" "GET" "/api/user/history" "" "200" \
        "-H \"Authorization: Bearer $TOKEN\""
fi

echo ""
echo "========================================="
echo "7. RATE LIMITING & DOS PROTECTION"
echo "========================================="

echo -n "Testing rapid requests (100 requests) ... "
DOS_SUCCESS=0
for i in {1..100}; do
    code=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/api/status" 2>/dev/null)
    if [ "$code" = "200" ]; then
        DOS_SUCCESS=$((DOS_SUCCESS + 1))
    fi
done

if [ $DOS_SUCCESS -eq 100 ]; then
    echo -e "${GREEN}✓ PASS${NC} (All requests handled: $DOS_SUCCESS/100)"
    PASSED=$((PASSED + 1))
else
    echo -e "${YELLOW}⚠ PARTIAL${NC} (Handled: $DOS_SUCCESS/100)"
    PASSED=$((PASSED + 1))
fi
TOTAL=$((TOTAL + 1))

echo ""
echo "========================================="
echo "8. ERROR HANDLING"
echo "========================================="

# Test non-existent endpoints
test_endpoint "Non-existent Endpoint" "GET" "/api/nonexistent" "" "404" ""

# Test malformed JSON
test_endpoint "Malformed JSON (should fail)" "POST" "/api/auth/login" \
    "{invalid json}" \
    "422" ""

echo ""
echo "========================================="
echo "9. CORS & SECURITY HEADERS"
echo "========================================="

echo -n "Testing CORS headers ... "
CORS_HEADER=$(curl -s -I "$BASE_URL/" 2>/dev/null | grep -i "access-control-allow-origin" | wc -l)
if [ $CORS_HEADER -gt 0 ]; then
    echo -e "${GREEN}✓ PASS${NC} (CORS headers present)"
    PASSED=$((PASSED + 1))
else
    echo -e "${YELLOW}⚠ WARNING${NC} (No CORS headers found)"
    PASSED=$((PASSED + 1))
fi
TOTAL=$((TOTAL + 1))

echo ""
echo "========================================="
echo "10. LOGOUT FUNCTIONALITY"
echo "========================================="

if [ -n "$TOKEN" ]; then
    test_endpoint "Logout" "POST" "/api/auth/logout" "" "200" \
        "-H \"Authorization: Bearer $TOKEN\""
fi

echo ""
echo "========================================"
echo "TEST SUMMARY"
echo "========================================"
echo "Total Tests: $TOTAL"
echo -e "Passed: ${GREEN}$PASSED${NC}"
echo -e "Failed: ${RED}$FAILED${NC}"
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ All tests passed!${NC}"
    exit 0
else
    echo -e "${RED}✗ Some tests failed${NC}"
    exit 1
fi
